name: Nmap DICOM Web Matrix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-dicom-web:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: orthanc-web
            compose: docker/docker-compose.web.yml
            service: orthanc
            port: 8042
            expect: "path: /system"
          - name: ohif-viewer
            compose: docker/docker-compose.web.yml
            service: viewer
            port: 3000
            expect: "ohif: /"

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y nmap docker-compose curl netcat-openbsd

      - name: Install updated NSE into /usr/share
        run: |
          set -euo pipefail
          sudo mkdir -p /usr/share/nmap/scripts
          sudo cp -f scripts/dicom-web-info.nse /usr/share/nmap/scripts/dicom-web-info.nse
          sudo chown root:root /usr/share/nmap/scripts/dicom-web-info.nse
          sudo chmod 0644 /usr/share/nmap/scripts/dicom-web-info.nse
          sudo nmap --script-updatedb
          nmap --script-help dicom-web-info | sed -n '1,60p' || true

      - name: Up ${{ matrix.target.name }}
        shell: bash
        run: |
          set -euo pipefail

          docker-compose -f ${{ matrix.target.compose }} up -d ${{ matrix.target.service }}

          # Wait for TCP
          for i in {1..120}; do
            if nc -z 127.0.0.1 ${{ matrix.target.port }}; then break; fi
            sleep 0.5
          done
          nc -zv 127.0.0.1 ${{ matrix.target.port }}

          if [ "${{ matrix.target.name }}" = "orthanc-web" ]; then
            # 1) Wait for a real auth challenge on /system (401/403 + WWW-Authenticate)
            for i in {1..120}; do
              RESP="$(curl -sS -o /dev/null -w '%{http_code} %{www_authenticate}' --max-time 2 "http://127.0.0.1:${{ matrix.target.port }}/system" || true)"
              read -r CODE WAUTH <<< "$RESP"
              if { [ "$CODE" = "401" ] || [ "$CODE" = "403" ]; } && [ -n "$WAUTH" ]; then
                break
              fi
              sleep 0.5
            done

            # 2) Verify default creds succeed (stabilizes version reporting)
            for i in {1..120}; do
              CODE="$(curl -sS -o /dev/null -w '%{http_code}' --max-time 2 -u orthanc:orthanc "http://127.0.0.1:${{ matrix.target.port }}/system" || true)"
              if [ "$CODE" = "200" ]; then
                break
              fi
              sleep 0.5
            done
          else
            # OHIF: look for a 200 on common mounts
            for i in {1..120}; do
              for p in "/" "/viewer/" "/ohif/"; do
                CODE="$(curl -sS -o /dev/null -w '%{http_code}' --max-time 2 "http://127.0.0.1:${{ matrix.target.port }}$p" || true)"
                if [ "$CODE" = "200" ]; then
                  break 2
                fi
              done
              sleep 0.5
            done
          fi

      - name: Scan ${{ matrix.target.name }}
        id: scan
        env:
          NMAPDIR: /usr/share/nmap
        run: |
          set -o pipefail
          OUT="nmap_http_${{ matrix.target.name }}.txt"
          nmap -p ${{ matrix.target.port }} --script dicom-web-info 127.0.0.1 | tee "$OUT"
          echo "out=$OUT" >> "$GITHUB_OUTPUT"

      - name: Assert ${{ matrix.target.name }} output
        run: |
          OUT="${{ steps.scan.outputs.out }}"
          if ! grep -F '${{ matrix.target.expect }}' "$OUT"; then
            echo "::error::Missing expected: ${{ matrix.target.expect }}"
            sed -n '1,200p' "$OUT" || true
            exit 1
          fi

      - name: Upload ${{ matrix.target.name }} artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nmap-http-${{ matrix.target.name }}
          path: ${{ steps.scan.outputs.out }}

      - name: Logs ${{ matrix.target.name }}
        if: always()
        run: docker-compose -f ${{ matrix.target.compose }} logs --tail=200 ${{ matrix.target.service }} || true

      - name: Down ${{ matrix.target.name }}
        if: always()
        run: docker-compose -f ${{ matrix.target.compose }} down -v --remove-orphans
