name: Rust C-ECHO (dicom-rs) smoke

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-c-echo-rs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install base deps
        run: |
          sudo apt-get update
          sudo apt-get install -y netcat-openbsd

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install dicom-echoscu
        run: |
          set -euxo pipefail
          cargo install --locked dicom-echoscu
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Start Orthanc (DIMSE on 11112)
        run: |
          set -e
          docker run -d --rm --name orthanc_test \
            -p 11112:4242 -p 8042:8042 \
            -e ORTHANC__REMOTE_ACCESS_ALLOWED=true \
            orthancteam/orthanc:latest
          # wait for DIMSE
          for i in {1..60}; do nc -z 127.0.0.1 11112 && break; sleep 1; done
          nc -z 127.0.0.1 11112

      - name: Run dicom-echoscu (C-ECHO)
        run: |
          set -euxo pipefail
          OUT="echoscu_orthanc.log"
          for i in {1..10}; do
            if dicom-echoscu --verbose --called-ae-title ORTHANC 127.0.0.1:11112 | tee "$OUT"; then
              break
            fi
            echo "ECHO failed (try $i); sleeping 1s…"; sleep 1
          done
          if grep -q "✓ C-ECHO successful" "$OUT" || grep -q "Status:[[:space:]]*0000H" "$OUT"; then
            echo "C-ECHO success confirmed."
          else
            echo "::error::ECHO never succeeded"; exit 1
          fi

      - name: Upload echoscu log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: echoscu-orthanc
          path: echoscu_orthanc.log

      - name: Down
        if: always()
        run: docker stop orthanc_test || true
